<mat-card class="users-card shadow-xs">
  <!-- Skip link for keyboard navigation -->
  <a class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 bg-browers-deep-purple text-browers-white px-4 py-2 rounded z-50"
     href="#users-content">Skip to users content</a>

  <mat-card-header class="border-b border-browers-light-grey pb-4">
    <mat-card-title class="text-browers-deep-purple text-xl font-semibold">Users Management</mat-card-title>
    <mat-card-subtitle class="text-browers-dark-grey mt-1">View and manage system users</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content class="pt-6" id="users-content">
    <!-- Loading skeleton with screen reader announcements -->
    @if (loading()) {
      <!-- Screen reader announcement for loading state -->
      <div class="sr-only" aria-live="polite">Loading users data, please wait...</div>

      <!-- Desktop Skeleton -->
      @if (!isMobile()) {
        <div class="skeleton-table" aria-hidden="true">
          <div class="skeleton-header bg-browers-light-grey h-12 mb-1"></div>
          @for (i of [1,2,3,4,5]; track i) {
            <div class="skeleton-row flex space-x-4 h-14 p-4 border-b border-browers-light-grey">
              <div class="skeleton-cell bg-browers-silver h-6 w-16 rounded animate-pulse"></div>
              <div class="skeleton-cell bg-browers-silver h-6 w-24 rounded animate-pulse"></div>
              <div class="skeleton-cell bg-browers-silver h-6 w-20 rounded animate-pulse"></div>
              <div class="skeleton-cell bg-browers-silver h-6 w-20 rounded animate-pulse"></div>
              <div class="skeleton-cell bg-browers-silver h-6 w-16 rounded animate-pulse"></div>
              <div class="skeleton-cell bg-browers-silver h-6 w-20 rounded animate-pulse"></div>
              <div class="skeleton-cell bg-browers-silver h-6 w-16 rounded animate-pulse"></div>
            </div>
          }
        </div>
      }

      <!-- Mobile Skeleton -->
      @if (isMobile()) {
        <div class="skeleton-cards space-y-4" aria-hidden="true">
          @for (i of [1,2,3]; track i) {
            <mat-card class="skeleton-card bg-browers-white shadow-xs border border-browers-light-grey">
              <mat-card-content class="p-4">
                <div class="flex justify-between items-start mb-3">
                  <div class="flex-1">
                    <div class="skeleton-text bg-browers-silver h-5 w-32 rounded animate-pulse mb-2"></div>
                    <div class="skeleton-text bg-browers-silver h-4 w-24 rounded animate-pulse"></div>
                  </div>
                  <div class="skeleton-badge bg-browers-silver h-6 w-16 rounded-full animate-pulse"></div>
                </div>

                <div class="space-y-2 mb-4">
                  <div class="flex justify-between">
                    <div class="skeleton-text bg-browers-silver h-4 w-8 rounded animate-pulse"></div>
                    <div class="skeleton-text bg-browers-silver h-4 w-20 rounded animate-pulse"></div>
                  </div>
                  <div class="flex justify-between">
                    <div class="skeleton-text bg-browers-silver h-4 w-16 rounded animate-pulse"></div>
                    <div class="skeleton-text bg-browers-silver h-4 w-24 rounded animate-pulse"></div>
                  </div>
                </div>

                <div class="flex space-x-2">
                  <div class="skeleton-button bg-browers-silver h-9 flex-1 rounded animate-pulse"></div>
                  <div class="skeleton-button bg-browers-silver h-9 flex-1 rounded animate-pulse"></div>
                </div>
              </mat-card-content>
            </mat-card>
          }
        </div>
      }
    }

    <!-- Error message -->
    @if (error(); as err) {
      <div class="error-message flex items-center gap-2 text-red-600 mb-6" role="alert" aria-live="polite">
        <mat-icon aria-hidden="true">error</mat-icon>
        <span class="font-medium">Error:</span>
        <span>{{ err }}</span>
      </div>
    }

    <!-- Users table/cards -->
    @if (!loading() && !error() && dataSource.data.length > 0) {
      <!-- Desktop Table View -->
      @if (!isMobile()) {
        <div class="table-container">
          <table
            mat-table
            [dataSource]="dataSource"
            matSort
            #sort="matSort"
            (matSortChange)="onSortChange($event)"
            class="users-table"
            aria-label="Users management table with sorting and pagination">

            <!-- ID Column -->
            <ng-container matColumnDef="id">
              <th mat-header-cell *matHeaderCellDef mat-sort-header
                  class="text-xs font-medium text-browers-steel-grey uppercase tracking-wider">ID</th>
              <td mat-cell *matCellDef="let user"
                  class="text-browers-charcoal font-mono">{{ user.id }}</td>
            </ng-container>

            <!-- Username Column -->
            <ng-container matColumnDef="username">
              <th mat-header-cell *matHeaderCellDef mat-sort-header
                  class="text-xs font-medium text-browers-steel-grey uppercase tracking-wider">Username</th>
              <td mat-cell *matCellDef="let user"
                  class="text-browers-charcoal font-medium">{{ user.username }}</td>
            </ng-container>

            <!-- Name Column -->
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef mat-sort-header
                  class="text-xs font-medium text-browers-steel-grey uppercase tracking-wider">Name</th>
              <td mat-cell *matCellDef="let user"
                  class="text-browers-charcoal">{{ user.name }}</td>
            </ng-container>

            <!-- Last Name Column -->
            <ng-container matColumnDef="last_name">
              <th mat-header-cell *matHeaderCellDef mat-sort-header
                  class="text-xs font-medium text-browers-steel-grey uppercase tracking-wider">Last Name</th>
              <td mat-cell *matCellDef="let user"
                  class="text-browers-charcoal">{{ user.last_name }}</td>
            </ng-container>

            <!-- Role Column -->
            <ng-container matColumnDef="role_id">
              <th mat-header-cell *matHeaderCellDef mat-sort-header
                  class="text-xs font-medium text-browers-steel-grey uppercase tracking-wider">Role</th>
              <td mat-cell *matCellDef="let user"
                  class="text-browers-charcoal">
                <span [ngClass]="{
                  'admin-badge': user.role.name === 'admin',
                  'user-badge': user.role.name !== 'admin'
                }">
                  {{ user.role.name }}
                </span>
              </td>
            </ng-container>

            <!-- Created At Column -->
            <ng-container matColumnDef="created_at">
              <th mat-header-cell *matHeaderCellDef mat-sort-header
                  class="text-xs font-medium text-browers-steel-grey uppercase tracking-wider">Created</th>
              <td mat-cell *matCellDef="let user"
                  class="text-browers-dark-grey text-sm">{{ formatDate(user.created_at) }}</td>
            </ng-container>

            <!-- Updated At Column -->
            <ng-container matColumnDef="updated_at">
              <th mat-header-cell *matHeaderCellDef mat-sort-header
                  class="text-xs font-medium text-browers-steel-grey uppercase tracking-wider">Updated</th>
              <td mat-cell *matCellDef="let user"
                  class="text-browers-dark-grey text-sm">{{ formatDate(user.updated_at) }}</td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef
                  class="text-xs font-medium text-browers-steel-grey uppercase tracking-wider">Actions</th>
              <td mat-cell *matCellDef="let user"
                  class="space-x-1">
                <button
                  mat-icon-button
                  color="primary"
                  [matTooltip]="'Edit ' + user.username"
                  (click)="updateUser(user.id, user)"
                  class="hover:bg-browers-light-purple hover:bg-opacity-10 focus:outline-hidden focus:ring-3 focus:ring-browers-deep-purple focus:ring-offset-1"
                  aria-label="Edit user">
                  <mat-icon>edit</mat-icon>
                </button>
                <button
                  mat-icon-button
                  color="warn"
                  [matTooltip]="'Delete ' + user.username"
                  (click)="deleteUser(user.id)"
                  class="hover:bg-red-50 focus:outline-hidden focus:ring-3 focus:ring-red-500 focus:ring-offset-1"
                  aria-label="Delete user">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns" class="bg-browers-light-grey sticky top-0 z-10"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="hover:bg-browers-light-grey hover:bg-opacity-50 transition-colors duration-150"></tr>
          </table>
        </div>
      }

      <!-- Mobile Card View -->
      @if (isMobile()) {
        <div class="mobile-cards-container space-y-4">
          @for (user of dataSource.data; track user.id) {
            <mat-card class="user-card bg-browers-white shadow-xs border border-browers-light-grey hover:shadow-md transition-shadow duration-200">
              <mat-card-content class="p-4">
                <div class="flex justify-between items-start mb-3">
                  <div class="flex-1">
                    <h3 class="text-lg font-semibold text-browers-deep-purple">{{ user.username }}</h3>
                    <p class="text-browers-dark-grey text-sm">{{ user.name }} {{ user.last_name }}</p>
                                      <span [ngClass]="{
                    'admin-badge': user.role.name === 'admin',
                    'user-badge': user.role.name !== 'admin'
                  }">
                    {{ user.role.name }}
                  </span>
                  </div>
                </div>

                <div class="grid grid-cols-1 gap-2 text-sm mb-4">
                  <div class="flex justify-between">
                    <span class="text-browers-steel-grey font-medium">ID:</span>
                    <span class="text-browers-charcoal font-mono">{{ user.id }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-browers-steel-grey font-medium">Created:</span>
                    <span class="text-browers-dark-grey">{{ formatDate(user.created_at) }}</span>
                  </div>
                </div>

                <div class="flex space-x-2 justify-end">
                  <button
                    mat-stroked-button
                    color="primary"
                    [matTooltip]="'Edit ' + user.username"
                    (click)="updateUser(user.id, user)"
                    class="flex-1 hover:bg-browers-light-purple hover:bg-opacity-10 focus:outline-hidden focus:ring-3 focus:ring-browers-deep-purple focus:ring-offset-1"
                    aria-label="Edit user">
                    <mat-icon class="mr-1">edit</mat-icon>
                    Edit
                  </button>
                  <button
                    mat-stroked-button
                    color="warn"
                    [matTooltip]="'Delete ' + user.username"
                    (click)="deleteUser(user.id)"
                    class="flex-1 hover:bg-red-50 focus:outline-hidden focus:ring-3 focus:ring-red-500 focus:ring-offset-1"
                    aria-label="Delete user">
                    <mat-icon class="mr-1">delete</mat-icon>
                    Delete
                  </button>
                </div>
              </mat-card-content>
            </mat-card>
          }
        </div>
      }

      <!-- Paginator (responsive) -->
      <mat-paginator
        #paginator
        [length]="totalUsers()"
        [pageSize]="paginationParams().pageSize"
        [pageIndex]="paginationParams().page"
        [pageSizeOptions]="pageSizeOptions"
        (page)="onPageChange($event)"
        [showFirstLastButtons]="!isMobile()"
        aria-label="Select page of users"
        class="border-t border-browers-light-grey bg-browers-white mt-4">
      </mat-paginator>
    }

    <!-- No data message -->
    @if (!loading() && !error() && dataSource.data.length === 0) {
      <div class="no-data-message">
        <mat-icon class="text-browers-silver text-6xl mb-4">people_outline</mat-icon>
        <p class="text-browers-steel-grey text-lg">No users found.</p>
        <p class="text-browers-steel-grey text-sm">Users will appear here when they are added to the system.</p>
      </div>
    }
  </mat-card-content>
</mat-card>